---
title: "Take Home Exercise 1"
date: "9 February 2023"
date-modified: "`r Sys.Date()`"
execute: 
  eval: true
  echo: true
  warning: false
editor: visual
---

# 1.0 Overview

## 1.1 Background

This analysis aims to apply appropriate spatial point patterns analysis methods to discover the geographical distribution of functional and non-function water points and their co-locations if any in Osun State, Nigeria.

## 1.2 Task

-   Exploratory Spatial Data Analysis (ESDA)

-   Second-order Spatial Point Pattern Analysis

-   Spatial Correlation Analysis

# 2.0 Setup

## 2.1 Import Packages

-   sf

-   tidyVerse

-   tmap, maptools, kableExtra - Used for visualizing dataframes and plots

```{r}
pacman::p_load(sf, maptools, raster, spatstat, tmap, kableExtra, tidyverse, funModeling)
```

# 3.0 Data Wrangling

## 3.1 Datasets Used

```{r}
#| code-fold: true
# initialise a dataframe of our geospatial and aspatial dataset details
datasets <- data.frame(
  Type=c("Geospatial",
         "Geospatial",
         "Geospatial",
         "Geospatial",
         "Geospatial",
         "Geospatial",
         "Geospatial",
         "Geospatial",
         "Geospatial",
         "Geospatial",
         "Geospatial",
         "Geospatial",
         "Geospatial",
         "Geospatial",
         
         "Aspatial"),
  
  Name=c("geoBoundaries-NGA-ADM2",
         "geoBoundaries-NGA-ADM2",
         "geoBoundaries-NGA-ADM2",
         "geoBoundaries-NGA-ADM2",
         "geoBoundaries-NGA-ADM2",
         "geoBoundaries-NGA-ADM2",
         "nga_admbnda_adm2_osgof_20190417",
         "nga_admbnda_adm2_osgof_20190417",
         "nga_admbnda_adm2_osgof_20190417",
         "nga_admbnda_adm2_osgof_20190417",
         "nga_admbnda_adm2_osgof_20190417",
         "nga_admbnda_adm2_osgof_20190417",
         "nga_admbnda_adm2_osgof_20190417",
         "nga_admbnda_adm2_osgof_20190417",
         
         "WPdx"),
  
  Format=c(".dbf", 
           ".geojson", 
           ".prj", 
           ".shp", 
           ".shx", 
           ".topojson",
           ".CPG",
           ".dbf",
           ".prj",
           ".sbn", 
           ".sbx", 
           ".shp", 
           ".shp", 
           ".shx", 
          
           ".csv"),
  
  Source=c("[geoBoundaries](https://www.geoboundaries.org/index.html#getdata)",
           "[geoBoundaries](https://www.geoboundaries.org/index.html#getdata)",
           "[geoBoundaries](https://www.geoboundaries.org/index.html#getdata)",
           "[geoBoundaries](https://www.geoboundaries.org/index.html#getdata)",
           "[geoBoundaries](https://www.geoboundaries.org/index.html#getdata)",
           "[geoBoundaries](https://www.geoboundaries.org/index.html#getdata)",
           
          "[Humanitarian Data Exchange](https://data.humdata.org/dataset/cod-ab-nga)",
           "[Humanitarian Data Exchange](https://data.humdata.org/dataset/cod-ab-nga)",
           "[Humanitarian Data Exchange](https://data.humdata.org/dataset/cod-ab-nga)",
           "[Humanitarian Data Exchange](https://data.humdata.org/dataset/cod-ab-nga)",
           "[Humanitarian Data Exchange](https://data.humdata.org/dataset/cod-ab-nga)",
           "[Humanitarian Data Exchange](https://data.humdata.org/dataset/cod-ab-nga)",
           "[Humanitarian Data Exchange](https://data.humdata.org/dataset/cod-ab-nga)",
           "[Humanitarian Data Exchange](https://data.humdata.org/dataset/cod-ab-nga)",
           
           "[ WPdx Global Data Repositories](https://www.waterpointdata.org/access-data/)")
  )

# with reference to this guide on kableExtra:
# https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html
# kable_material is the name of the kable theme
# 'hover' for to highlight row when hovering, 'scale_down' to adjust table to fit page width
library(knitr)
library(kableExtra)
kable(datasets, caption="Datasets Used") %>%
  kable_material("hover", latex_options="scale_down")

```

## 3.2 Geospatial Data

### 3.2.1 Load Data

::: panel-tabset
#### Import

```{r}
NGA <- st_read("data/geospatial", 
                  layer = "nga_admbnda_adm2_osgof_20190417") %>%
  filter(ADM1_EN == "Osun") %>%
  st_transform(crs = 26392)
```

#### Glimpse

```{r}
glimpse(NGA)
```
:::

### 3.2.2 Data Preprocessing

#### 3.2.2.1 Excluding redundant fields 

This is because

```{r}
NGA <- NGA %>%
  select(c(3:4, 8:9)) #dplyr
```

#### 3.2.2.2 Invalid Geometries

```{r}
length(which(st_is_valid(NGA) == FALSE))
```

Everything is valid

#### 3.2.2.3 Checking for Duplicate Names

```{r}
NGA$ADM2_EN[duplicated(NGA$ADM2_EN)==TRUE]
```

No duplicate names

#### 3.2.2.4 Remove Missing Values

```{r}
NGA[rowSums(is.na(NGA))!=0,]
```

### 3.2.3 Initial Visualisation

```{r}
plot(st_geometry(NGA))
```

## 3.3 Aspatial Data

### 3.3.1 Load Data

::: panel-tabset
#### Import

```{r}
wp_nga <- read_csv("data/aspatial/WPdx.csv") %>%
  filter(`#clean_country_name` == "Nigeria" & `#clean_adm1` == "Osun")
```

#### Glimpse

```{r}
glimpse(wp_nga)
```
:::

### 3.3.2 Data Preprocessing

#### 3.3.2.1 Convert point data to sf point features

First convert wkt field into sfc field. Then convert it into sf object.

```{r}
wp_nga$Geometry = st_as_sfc(wp_nga$`New Georeferenced Column`)

wp_sf <- st_sf(wp_nga, crs=4326)
```

#### 3.3.2.2 Transform into Coordinate System

```{r}
wp_sf <- wp_sf %>%
  st_transform(crs = 26392)
```

#### 3.3.2.3 Handle Missing Data 

```{r}
freq(data = wp_sf,
     input = '#status_clean')
```

There are eight classes in the #status_clean fields.

To change NA with "unknown"

```{r}
wp_sf_nga <- wp_sf %>% 
  rename(status_clean = '#status_clean') %>%
  select(status_clean) %>%
  mutate(status_clean = replace_na(
    status_clean, "unknown"))
```

### 3.3.3 Water Point Extraction

Functional Points

```{r}
wp_functional <- wp_sf_nga %>%
  filter(status_clean %in%
           c("Functional",
             "Functional, needs repair",
             "Functional, not in use",
             "Functional but not in use"))
```

Non-Functional Points

```{r}
wp_nonfunctional <- wp_sf_nga %>%
  filter(status_clean %in%
           c("Abandoned/Decommissioned",
             "Non-Functional, dry",
             "Non-Functional"))
```

Unknown Status Points

```{r}
wp_unknown <- wp_sf_nga %>%
  filter(status_clean == "unknown")
```

::: panel-tabset
#### Functional

```{r}
freq(data = wp_functional,
     input = 'status_clean')
```

#### Non-Functional

```{r}
freq(data = wp_nonfunctional,
     input = 'status_clean')
```

#### Unknown

```{r}
freq(data = wp_unknown,
     input = 'status_clean')
```
:::

### 3.3.4 Point-in-Polygon Count 

Extract number of total, functional, nonfunctional and unknown water points

```{r}
NGA_wp <- NGA %>% 
  mutate(`total_wp` = lengths(
    st_intersects(NGA, wp_sf_nga))) %>%
  mutate(`wp_functional` = lengths(
    st_intersects(NGA, wp_functional))) %>%
  mutate(`wp_nonfunctional` = lengths(
    st_intersects(NGA, wp_nonfunctional))) %>%
  mutate(`wp_unknown` = lengths(
    st_intersects(NGA, wp_unknown)))
```

## 3.4 Combined Data Wrangling

### 3.4.1 Convert sf dataframes to sp Spatial class

```{r}
wp_functional_spat = as_Spatial(wp_functional)
wp_nonfunctional_spat = as_Spatial(wp_nonfunctional)
NGA_spat = as_Spatial(NGA)
```

Peek

::: panel-tabset
#### Functional

```{r}
wp_functional_spat
```

#### Non-Functional

```{r}
wp_nonfunctional_spat
```

#### NGA

```{r}
NGA_spat
```
:::

### 3.4.2 Convert sp Spatial to generic sp format

```{r}
wp_functional_sp <- as(wp_functional_spat, "SpatialPoints")
wp_nonfunctional_sp <- as(wp_nonfunctional_spat, "SpatialPoints")
NGA_sp <-as(NGA_spat, "SpatialPolygons")
```

Peek

::: panel-tabset
#### Functional 

```{r}
wp_functional_sp
```

#### Non-Functional

```{r}
wp_nonfunctional_sp
```

#### NGA

```{r}
NGA_sp
```
:::

### 3.4.3 Convert generic sp to spatstat ppp format

```{r}
# from sp object, convert into ppp format
wp_functional_ppp <- as(wp_functional_sp, "ppp")
wp_nonfunctional_ppp <- as(wp_nonfunctional_sp, "ppp")
```

View

```{r}
par(mfrow=c(1,2))
plot(wp_functional_ppp)
plot(wp_nonfunctional_ppp)
```

#### 3.4.3.1 Check for Duplication

```{r}
any(duplicated(wp_functional_ppp)); any(duplicated(wp_nonfunctional_ppp)) 
```

No duplicates means no jittering needed

### 3.4.4 Create Owin object

```{r}
NGA_owin <- as(NGA_sp, "owin")
plot(NGA_owin)
```

### 3.4.4 Combine point event object with Owin object

```{r}
wp_functional_ppp = wp_functional_ppp[NGA_owin]
wp_nonfunctional_ppp = wp_nonfunctional_ppp[NGA_owin]
```

View

```{r}
par(mfrow=c(1,2))
plot(wp_functional_ppp)
plot(wp_nonfunctional_ppp)
```

# 4.0 Exploratory Spatial Data Analysis (ESDA)

-   Derive kernel density maps of functional and non-functional water points

-   Display kernel density maps of Osun State

-   Describe spatial patterns displayed by the kernel density maps

## 4.1 Kernel Density Estimation 
